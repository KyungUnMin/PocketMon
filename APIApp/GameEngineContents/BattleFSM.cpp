#include "BattleFSM.h"
#include <GameEngineBase/GameEngineDebug.h>
#include "BattleLevel.h"
#include "BattleEnemy.h"
#include "BattleState_WildTalk.h"
#include "BattleState_PlayerTurn.h"
#include "BattleState_EnemyTurn.h"
#include "BattleState_ThrowMonsterBall.h"

BattleFSM::BattleFSM()
{

}

BattleFSM::~BattleFSM()
{
	for (size_t i = 0; i < AllState.size(); ++i)
	{
		if (nullptr == AllState[i])
			continue;

		delete AllState[i];
		AllState[i] = nullptr;
	}
}


void BattleFSM::Init(BattleFieldType _FieldType, BattleNpcType _NpcType)
{
	AllState.resize(static_cast<size_t>(BattleStateType::COUNT), nullptr);
	for (size_t i = 0; i < AllState.size(); ++i)
	{
		CreateState(static_cast<BattleStateType>(i));
	}

	switch (_NpcType)
	{
	case BattleNpcType::None:
		BattleEnemy::EnemyPtr->CreateWildMonster(_FieldType);
		ChangeState(BattleStateType::WildTalk);
		break;
	default:
		MsgAssert("배틀 FSM에서 아직 연결해주지 않은 전투상황입니다");
		break;
	}
}






void BattleFSM::CreateState(BattleStateType _Type)
{
	BattleStateBase* NewState = nullptr;

	switch (_Type)
	{
	case BattleStateType::WildTalk:
		NewState = new BattleState_WildTalk;
		break;
	case BattleStateType::PlayerTurn:
		NewState = new BattleState_PlayerTurn;
		break;
	case BattleStateType::EnemyTurn:
		NewState = new BattleState_EnemyTurn;
		break;
	case BattleStateType::ThrowMonsterBall:
		NewState = new BattleState_ThrowMonsterBall;
		break;
	default:
		MsgAssert("아직 FSM과 해당 배틀State를 연결해주지 않았습니다");
		return;
	}

	NewState->FsmPtr = this;
	AllState[static_cast<size_t>(_Type)] = NewState;
}






void BattleFSM::ChangeState(BattleStateType _NextStateType)
{
	BattleStateBase* PrevState = nullptr;
	if (BattleStateType::COUNT != CurStateType)
	{
		PrevState = AllState[static_cast<size_t>(CurStateType)];
	}

	BattleStateBase* NextState = AllState[static_cast<size_t>(_NextStateType)];

	if (nullptr == NextState)
	{
		MsgAssert("바꾸려는 배틀 State는 만들어준 적이 없습니다");
		return;
	}

	if (nullptr != PrevState)
	{
		PrevState->ExitState();
	}

	NextState->EnterState();

	CurStateType = _NextStateType;
}



void BattleFSM::Update(float _DeltaTime)
{
	if (BattleStateType::COUNT == CurStateType)
	{
		MsgAssert("현재 배틀 상태를 설정해주지 않았습니다");
	}

	AllState[static_cast<size_t>(CurStateType)]->Update(_DeltaTime);
}


